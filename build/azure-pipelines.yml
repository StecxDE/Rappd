trigger:
  branches:
    include:
    - '*'

pool:
  vmImage: 'ubuntu-latest'

stages:

- stage: Build
  jobs:
  - job: BuildProjects
    steps:
    - checkout: self
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '6.x'
    - task: DotNetCoreCLI@2
      inputs:
        command: 'restore'
        projects: 'tests/**/*.csproj'
        feedsToUse: 'select'
        vstsFeed: '8ca3377a-8442-4cfd-a59e-3a4e0145faf9/978ff997-a2ff-4c4b-bb98-1dee8090e599'
    - task: DotNetCoreCLI@2
      inputs:
        command: 'build'
        projects: 'tests/**/*.csproj'
    - task: CopyFiles@2
      inputs:
        Contents: '**/bin/**'
        TargetFolder: '$(Build.StagingDirectory)/bin'
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.StagingDirectory)/bin'
        ArtifactName: 'bin'
        publishLocation: 'Container'

- stage: Test
  dependsOn: Build
  jobs:
  - job: ExecuteTests
    steps:
    - checkout: self
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'bin'
        downloadPath: '$(System.ArtifactsDirectory)'
    - task: CopyFiles@2
      inputs:
        SourceFolder: '$(System.ArtifactsDirectory)/bin'
        Contents: '**'
        TargetFolder: '$(Build.Repository.LocalPath)'
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '6.x'
    - task: DotNetCoreCLI@2
      inputs:
        command: 'test'
        projects: 'tests/**/*.csproj'
        arguments: '--logger trx --collect:"XPlat Code Coverage" --results-directory "$(Build.StagingDirectory)/results"'
        publishTestResults: false
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.StagingDirectory)/results'
        ArtifactName: 'results'
        publishLocation: 'Container'
  - job: ProcessTestResults
    dependsOn: ExecuteTests
    steps:
    - checkout: none
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'results'
        downloadPath: '$(System.ArtifactsDirectory)'
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '6.x'
    - task: DotNetCoreCLI@2
      inputs:
        command: 'custom'
        custom: 'tool'
        arguments: 'install --global dotnet-coverage'
    - script: mkdir $(System.ArtifactsDirectory)/test
    - task: DotNetCoreCLI@2
      displayName: 'dotnet custom'
      inputs:
        command: custom
        custom: coverage
        arguments: 'merge $(System.ArtifactsDirectory)/results/*.cobertura.xml --recursive --output $(Build.StagingDirectory)/test/merged.cobertura.xml --output-format cobertura'
    - task: CopyFiles@2
      inputs:
        SourceFolder: '$(System.ArtifactsDirectory)/results'
        Contents: '**/*.trx'
        TargetFolder: '$(Build.StagingDirectory)/test'
        flattenFolders: true
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.StagingDirectory)/test'
        ArtifactName: 'test'
        publishLocation: 'Container'

- stage: Publish
  dependsOn: Test
  jobs:
  - job: UploadToCodacy
    steps:
    - checkout: none
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'test'
        itemPattern: '**/*.cobertura.xml'
        downloadPath: '$(System.ArtifactsDirectory)'
    - task: Bash@3
      inputs:
        targetType: 'inline'
        script: |
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report -r $(System.ArtifactsDirectory)/test/merged.cobertura.xml
      env:
        CODACY_PROJECT_TOKEN: $(CODACYPROJECTTOKEN)
  - job: UploadToDevOps
    steps:
    - checkout: none
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'test'
        itemPattern: '**'
        downloadPath: '$(System.ArtifactsDirectory)'
    - task: UseDotNet@2
      inputs:
        version: 7.0.x
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '*.trx'
        searchFolder: '$(System.ArtifactsDirectory)/test'
        mergeTestResults: true
    - task: PublishCodeCoverageResults@1
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: '$(System.ArtifactsDirectory)/test/merged.cobertura.xml'